This page was created to collaborate the effort to merge the snapshots feature into Ext4.

==Ext4 snapshots mile stones==
Each of following mile stones will make the snapshot feature available to a wider group of ext4 users:
# Apply the current patches to ext4 code - snapshots with ext4 when only Next3 supported features are enabled (no extents, no 64bit, etc).
# Add support for new ext4 features (excluding 64bit support) - snapshots for common ext4 deployments.
# Optimize extent mapped file delete performance - combine snapshot functionality with ext4 high performance.
# Add support for Next3 unsupported features (no journal, no bh, direct I/O, journaled quota, block size != page size) - snapshots for special ext4 deployments.
# Add support for 64bit - snapshots for large scale ext4 deployments.


==Ext4 snapshots merge tasks==
The [[Next3 snapshot patches]] add snapshot support to Next3 (after it was cloned from Ext3).

Following is an estimation of the work that has to be done on each patch or group of patches to merge it into Ext4.

The colors indicate the nature of the merge tasks:
* '''Trivial''' - apply current patches to ext4 code.
* '''<font color=green>Enhancement</font>''' - changes to current patches to enhance code clarity and to catch up with new ext4 features.
* '''<font color=blue>Optimization</font>''' - not a must for functionality, but needed in order to catch up with ext4 performance improvements.
* '''<font color=red>Challenging</font>''' - should be designed in collaboration with other ext4 developers.

===Snapshot debug patch===
* Add generic debug functions.

===Snapshot hooks patches===
* Add snapshot hooks inside JBD2 meta data write hooks.
* Add snapshot hooks inside ext4_free_blocks().
* Move indirect mapped file data blocks to snapshot on write.
* <font color=red>Move or copy extent mapped file data blocks to snapshot on write.</font>

===Snapshot file patches===
* Snapshot implementation as an indirect mapped file, that can map up to 32bit block offsets.
* <font color=green>Move read-though code from get_blocks_handle() to snapshot_get_block().</font>
* <font color=green>Move snapshot_get_block() and snapshot_readpage() from inode.c to new snapshot_inode.c file.</font>
* <font color=red>Snapshot implementation as a new extent mapped file format, that can map up to 48bit of block offsets.</font>
* <font color=green>Add support for direct I/O.</font>

===Snapshot block operation patches===
* Copy meta data blocks to snapshot.
* Move deleted blocks to snapshot.
* <font color=blue>Fast move of large group of deleted blocks to reduce the performance impact on extent mapped file deletion.</font>
* Move indirect mapped file data blocks to snapshot on write.
* <font color=red>Move or copy extent mapped file data blocks to snapshot on write.</font>
* <font color=red>Add support block size != page size.</font>

===Snapshot control patches===
* Add snapshot control via SETFLAGS ioctl.
* <font color=green>Implement the simplified [[User-kernel API]].</font>
* <font color=green>Initialize global metadata of new ext4 features on snapshot take (like meta block group descriptors).</font>

===Snapshot journaling patches===
* Journal snapshot block operations in current transaction.
* <font color=green>Check for new JBD2 API's that require special attention.</font>
* <font color=green>Add support for journaled quota.</font>

===Snapshot list patches===
* Add snapshot list operations and read-through to previous snapshot.

===Snapshot race patches===
* Add protection for snapshot race conditions.
* <font color=red>Stop using buffer heads for synchronization of snapshot block operations.</font>

===Snapshot exclude bitmap patches===
* Keep the exclude bitmap up-to-date with snapshot file blocks.

===Snapshot cleanup patches===
* Reclaim deleted snapshot file blocks.
* <font color=green>Move snapshot_shrink_blocks() and snapshot_merge_blocks() from inode.c to new snapshot_inode.c file.</font>

